// Generate buildInfo.ts with commit hash and timestamp for display in the UI
// Uses CommonJS to avoid ESM loader issues regardless of package type
const { execSync } = require('node:child_process');
const { writeFileSync } = require('node:fs');
const { resolve } = require('node:path');

function getCommitShort() {
  try {
    return execSync('git rev-parse --short HEAD', { stdio: ['ignore', 'pipe', 'ignore'] })
      .toString()
      .trim();
  } catch (_) {
    return 'dev';
  }
}

function getCommitFull() {
  try {
    return execSync('git rev-parse HEAD', { stdio: ['ignore', 'pipe', 'ignore'] })
      .toString()
      .trim();
  } catch (_) {
    return 'dev';
  }
}

const commitShort = process.env.VITE_COMMIT_SHA?.slice(0, 7) || getCommitShort();
const commit = process.env.VITE_COMMIT_SHA || getCommitFull();
const builtAt = new Date().toISOString();

const out = `// Auto-generated by scripts/gen-build-info.cjs
// Do not edit manually. Values are injected at build time.
export const BUILD_INFO = {
  commitShort: ${JSON.stringify(commitShort)},
  commit: ${JSON.stringify(commit)},
  builtAt: ${JSON.stringify(builtAt)}
} as const;
`;

const filePath = resolve(__dirname, '..', 'buildInfo.ts');
writeFileSync(filePath, out, 'utf8');
console.log(`[gen-build-info] Wrote ${filePath}:`, commitShort, builtAt);
